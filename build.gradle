plugins {
    id "com.jfrog.bintray" version "1.7.3"
}

ext {
    vScala = System.properties.scalaVersion ?: '2.11'
    vRapture = 2.0
    vHz = 3.7
}

tasks.withType(ScalaCompile) {
    def args = System.properties.compilerArgs ?: "-feature -deprecation -explaintypes -unchecked -Xlint"
    scalaCompileOptions.additionalParameters = args.split(" ").toList()
}

version = "0.9.0-SNAPSHOT"
def bintrayVersion = {
    if (version.endsWith('-SNAPSHOT')) {
        java.text.SimpleDateFormat format = new java.text.SimpleDateFormat('yyMMddHHmm')
        format.setCalendar(Calendar.getInstance(TimeZone.getTimeZone('UTC')))
        return version.replace('SNAPSHOT', "b" + format.format(new Date()))
    } else {
        return version
    }
}()

allprojects {
    apply plugin: 'scala'
    apply plugin: 'eclipse'
    apply plugin: 'maven-publish'
    apply plugin: 'com.jfrog.bintray'

    sourceCompatibility = 1.7
    if (vScala == '2.11') {
        targetCompatibility = 1.7
    } else {
        targetCompatibility = 1.8
    }

    repositories {
        mavenCentral()
        jcenter()
        maven {
            url "http://dl.bintray.com/nilskp/maven" 
        }
    }
    dependencies {
        compileOnly "org.scala-lang:scala-library:$vScala.+"
        compileOnly "org.scala-lang:scala-reflect:$vScala.+"
        testCompile "junit:junit:4.+"
        testCompile "org.mockito:mockito-all:1.10.+"
        testCompile "com.propensive:rapture-json-jackson_$vScala:$vRapture.+" 
    }

    jar {
        baseName = "${project.name}_$vScala"
        manifest {
            attributes "Implementation-Title": project.name, "Implementation-Version": project.version
        }
    }

    publishing {
        publications {
            maven(MavenPublication) {
                groupId 'nilskp'
                artifactId jar.baseName
                version bintrayVersion
    
                from components.java
                artifact sourceJar
                artifact docsJar
            }
        }
    }

    bintray {
        user = System.properties.bintrayUser ?: "n/a"
        key = System.properties.bintrayApiKey ?: "n/a"
        dryRun = (user == "n/a" || key == "n/a")
        publish = true
        publications = ['maven']
        pkg {
            repo = "maven"
            name = "Ulysses"
            version {
                name = bintrayVersion
            }
        }
    }
}

dependencies {
    compile "nilskp:scuff_$vScala:0.1.5-b1612132306"
}

subprojects {
    version = rootProject.version
    dependencies {
        testCompile rootProject.sourceSets.test.output
        compile rootProject
    }
}

task wrapper(type: Wrapper) {
    gradleVersion = '3.2.1'
}

task sourceJar(type: Jar) {
    classifier "sources"
    from sourceSets.main.allScala
}
task docsJar(type: Jar, dependsOn: scaladoc) {
    classifier "docs"
    from scaladoc.destinationDir
}

project(':ulysses-cassandra') {
    dependencies {
        compile "com.datastax.cassandra:cassandra-driver-core:3.1.+"
    }
}
project(':ulysses-jdbc') {
    dependencies {
        testCompile "com.h2database:h2:1.4.+"
        testCompile "org.apache.derby:derby:10.12.+"
    }
}
project(':ulysses-mongodb') {
    dependencies {
        compile "org.mongodb:mongodb-driver-async:3.3.+"
    }
}
project(':ulysses-hazelcast') {
    dependencies {
        compile "com.hazelcast:hazelcast:$vHz.+"
        compile "com.hazelcast:hazelcast-scala_$vScala:$vHz.+"
    }
}
